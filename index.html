<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Air Hockey Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loading-container {
            text-align: center;
            color: white;
            z-index: 1000;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .game-container {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .loading-logo {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        .loading-text {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .loading-bar-container {
            width: 300px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin: 0 auto;
            overflow: hidden;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .loading-percentage {
            margin-top: 1rem;
            font-size: 1rem;
            opacity: 0.8;
        }

        .unity-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .loading-dots {
            display: inline-block;
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .loading-logo {
                font-size: 2rem;
            }
            
            .loading-bar-container {
                width: 250px;
            }
            
            .loading-text {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-container" id="loadingContainer">
        <div class="loading-logo">ðŸŽ® NFT Air Hockey</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Game<span class="loading-dots"></span></div>
        <div class="loading-bar-container">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
        <div class="loading-percentage" id="loadingPercentage">0%</div>
    </div>

    <!-- Game Container -->
    <div class="game-container" id="gameContainer">
        <canvas id="unity-canvas" class="unity-canvas"></canvas>
    </div>

    <script>
        // Unity WebGL Configuration
        const buildUrl = "public/game/Build";
        const config = {
            dataUrl: buildUrl + "/Webgl.data",
            frameworkUrl: buildUrl + "/Webgl.framework.js",
            codeUrl: buildUrl + "/Webgl.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "NFT Air Hockey",
            productName: "NFT Air Hockey Game",
            productVersion: "1.0",
            // Additional Unity WebGL settings
            matchWebGLToCanvasSize: true,
            devicePixelRatio: window.devicePixelRatio || 1
        };

        // Global variables
        let unityInstance = null;
        let loadingStartTime = Date.now();
        let loadingSteps = [
            { name: "Initializing...", progress: 0 },
            { name: "Loading Framework...", progress: 0.1 },
            { name: "Downloading Game Data...", progress: 0.3 },
            { name: "Compiling WebAssembly...", progress: 0.6 },
            { name: "Starting Game Engine...", progress: 0.8 },
            { name: "Almost Ready...", progress: 0.95 }
        ];
        let currentStep = 0;

        // DOM elements
        const loadingContainer = document.getElementById('loadingContainer');
        const gameContainer = document.getElementById('gameContainer');
        const loadingBar = document.getElementById('loadingBar');
        const loadingPercentage = document.getElementById('loadingPercentage');
        const loadingText = document.querySelector('.loading-text');
        const canvas = document.getElementById('unity-canvas');

        // Initialize loading screen
        loadingContainer.style.display = 'block';
        gameContainer.style.display = 'none';

        // Enhanced loading progress tracking
        class UnityLoader {
            constructor() {
                this.progress = 0;
                this.isLoading = true;
                this.loadingSteps = loadingSteps;
                this.currentStepIndex = 0;
                this.startTime = Date.now();
                this.retryCount = 0;
                this.maxRetries = 3;
            }

            updateProgress(progress) {
                this.progress = progress;
                const percentage = Math.round(progress * 100);
                
                // Update progress bar with smooth animation
                loadingBar.style.width = percentage + "%";
                loadingPercentage.textContent = percentage + "%";
                
                // Update loading text based on progress
                this.updateLoadingText(progress);
                
                // Log progress for debugging
                console.log(`Loading progress: ${percentage}%`);
            }

            updateLoadingText(progress) {
                const stepIndex = Math.floor(progress * this.loadingSteps.length);
                if (stepIndex < this.loadingSteps.length && stepIndex !== this.currentStepIndex) {
                    this.currentStepIndex = stepIndex;
                    const currentStep = this.loadingSteps[stepIndex];
                    loadingText.innerHTML = currentStep.name + '<span class="loading-dots"></span>';
                }
            }

            onLoadingComplete() {
                this.isLoading = false;
                const loadTime = Date.now() - this.startTime;
                console.log(`Game loaded successfully in ${loadTime}ms`);
                
                // Update final loading text
                loadingText.innerHTML = 'Game Ready!<span class="loading-dots"></span>';
                
                // Smooth transition to game
                setTimeout(() => {
                    this.hideLoadingScreen();
                }, 800);
            }

            hideLoadingScreen() {
                // Fade out loading screen
                loadingContainer.style.opacity = '0';
                loadingContainer.style.transition = 'opacity 0.5s ease-out';
                
                setTimeout(() => {
                    loadingContainer.style.display = 'none';
                    gameContainer.style.display = 'block';
                    
                    // Resize canvas to fit container
                    this.resizeCanvas();
                    
                    // Initialize game controls
                    this.initializeGameControls();
                }, 500);
            }

            resizeCanvas() {
                const container = gameContainer;
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                
                // Set canvas size to match container
                canvas.width = containerWidth;
                canvas.height = containerHeight;
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                
                // Notify Unity of resize if instance exists
                if (unityInstance) {
                    unityInstance.SendMessage('GameManager', 'OnWindowResize', '');
                }
            }

            initializeGameControls() {
                // Add game-specific controls and event listeners
                this.setupKeyboardControls();
                this.setupTouchControls();
                this.setupFullscreenControls();
            }

            setupKeyboardControls() {
                document.addEventListener('keydown', (e) => {
                    // Prevent default browser behavior for game keys
                    const gameKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space', 'Enter'];
                    if (gameKeys.includes(e.key)) {
                        e.preventDefault();
                    }
                    
                    // Handle fullscreen toggle
                    if (e.key === 'F11') {
                        e.preventDefault();
                        this.toggleFullscreen();
                    }
                    
                    // Handle escape key
                    if (e.key === 'Escape' && document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                });
            }

            setupTouchControls() {
                // Add touch event handling for mobile devices
                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                }, { passive: false });
                
                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                }, { passive: false });
            }

            setupFullscreenControls() {
                // Handle fullscreen changes
                document.addEventListener('fullscreenchange', () => {
                    setTimeout(() => {
                        this.resizeCanvas();
                    }, 100);
                });
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log('Error attempting to enable fullscreen:', err);
                    });
                } else {
                    document.exitFullscreen();
                }
            }

            onLoadingError(error) {
                console.error('Unity loading error:', error);
                this.retryCount++;
                
                if (this.retryCount <= this.maxRetries) {
                    loadingText.innerHTML = `Retrying... (${this.retryCount}/${this.maxRetries})<span class="loading-dots"></span>`;
                    setTimeout(() => {
                        this.retryLoad();
                    }, 2000);
                } else {
                    loadingText.innerHTML = 'Failed to load game. Please refresh the page.';
                    loadingPercentage.textContent = 'Error';
                }
            }

            retryLoad() {
                // Reset progress
                this.progress = 0;
                this.currentStepIndex = 0;
                loadingBar.style.width = '0%';
                loadingPercentage.textContent = '0%';
                
                // Reload the Unity loader script
                this.loadUnityGame();
            }

            loadUnityGame() {
                // Create and load Unity loader script
                const script = document.createElement("script");
                script.src = buildUrl + "/Webgl.loader.js";
                script.onload = () => {
                    this.initializeUnity();
                };
                script.onerror = () => {
                    this.onLoadingError('Failed to load Unity loader script');
                };
                document.body.appendChild(script);
            }

            initializeUnity() {
                try {
                    createUnityInstance(canvas, config, (progress) => {
                        this.updateProgress(progress);
                    }).then((instance) => {
                        unityInstance = instance;
                        window.unityInstance = instance; // Global reference
                        this.onLoadingComplete();
                    }).catch((error) => {
                        this.onLoadingError(error);
                    });
                } catch (error) {
                    this.onLoadingError(error);
                }
            }
        }

        // Initialize the loader
        const loader = new UnityLoader();
        loader.loadUnityGame();

        // Handle window resize
        window.addEventListener('resize', () => {
            if (loader && !loader.isLoading) {
                loader.resizeCanvas();
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (unityInstance) {
                if (document.hidden) {
                    // Game is hidden, pause if needed
                    unityInstance.SendMessage('GameManager', 'OnApplicationPause', 'true');
                } else {
                    // Game is visible, resume if needed
                    unityInstance.SendMessage('GameManager', 'OnApplicationPause', 'false');
                }
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (unityInstance) {
                unityInstance.SendMessage('GameManager', 'OnApplicationQuit', '');
            }
        });

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
                }, 0);
            });
        }

        // Error handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
        });
    </script>
</body>
</html>
